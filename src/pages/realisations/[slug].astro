---
import Layout from '~/layouts/PageLayout.astro';
import { getAllRealisations, getRealisationBySlug } from '~/utils/api';

// Définir les interfaces de type pour les données
interface RealisationMeta {
  client?: string;
  periode?: string;
  technologies?: string[];
  impact?: string;
  challenge?: string;
  solution?: string;
  features?: Array<{ title: string; description: string; icon: string }>;
  testimonial?: {
    quote: string;
    author: string;
    role: string;
    image: string;
  };
}

interface Category {
  name: string;
  slug: string;
}

interface FeaturedImage {
  node: {
    mediaItemUrl: string;
    altText: string;
    srcSet?: string;
    sourceUrl?: string;
    mediaDetails?: {
      height: number;
      width: number;
    };
  };
}

interface Realisation {
  id: string;
  title: string;
  excerpt?: string;
  content?: string;
  date?: string;
  slug?: string;
  uri?: string;
  categories?: {
    nodes: Category[];
  };
  featuredImage?: FeaturedImage;
  realisationsMeta?: RealisationMeta;
  gallery?: string[];
}

interface Project {
  title: string;
  category: string;
  client: string;
  date: string;
  heroImage: string;
  description: string;
  challenge: string;
  solution: string;
  technologies: string[];
  features: Array<{ title: string; description: string; icon: string }>;
  results: string[];
  testimonial: null | {
    quote: string;
    author: string;
    role: string;
    image: string;
  };
  gallery: string[];
  content?: string;
}

// Fonction helper pour nettoyer l'HTML
function stripHTML(html: string): string {
  return html.replace(/<[^>]*>/g, '').trim();
}

// Générer les routes statiques
export async function getStaticPaths() {
  const realisations: Realisation[] = await getAllRealisations();
  
  return realisations.map((realisation: Realisation) => ({
    params: { slug: realisation.slug || `realisation-${realisation.id}` },
    props: { realisation }
  }));
}

const { slug } = Astro.params;
const { realisation } = Astro.props as { realisation?: Realisation };

// Si pas de props, essayer de récupérer depuis l'API
let realisationData = realisation;
if (!realisationData) {
  realisationData = await getRealisationBySlug(slug);
}

// Si toujours pas de données, rediriger vers 404
if (!realisationData) {
  return Astro.redirect('/404');
}

// Transformer les données de l'API pour correspondre à la structure attendue par le template
const projet: Project = {
  title: realisationData.title,
  category: realisationData.categories?.nodes?.[0]?.name || 'Réalisation',
  client: realisationData.realisationsMeta?.client || 'CitizenLab Bénin',
  date: realisationData.date ? new Date(realisationData.date).toLocaleDateString('fr-FR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }) : 'Date non spécifiée',
  heroImage: realisationData.featuredImage?.node?.mediaItemUrl || '/assets/images/default.png',
  description: realisationData.excerpt 
    ? stripHTML(realisationData.excerpt)
    : (realisationData.content ? stripHTML(realisationData.content.substring(0, 200) + '...') : 'Découvrez ce projet de CitizenLab Bénin'),
  challenge: realisationData.realisationsMeta?.challenge || 'Un projet innovant pour améliorer la participation citoyenne et renforcer l\'engagement des communautés locales.',
  solution: realisationData.realisationsMeta?.solution || 'Une solution développée en collaboration avec nos partenaires, utilisant les technologies modernes pour maximiser l\'impact.',
  technologies: realisationData.realisationsMeta?.technologies || ['Innovation sociale', 'Participation citoyenne', 'Numérique'],
  features: realisationData.realisationsMeta?.features || [
    {
      title: 'Engagement citoyen',
      description: 'Facilite la participation active des citoyens',
      icon: 'tabler:users'
    },
    {
      title: 'Innovation',
      description: 'Utilise des technologies modernes et adaptées',
      icon: 'tabler:bulb'
    },
    {
      title: 'Impact mesurable',
      description: 'Résultats concrets et quantifiables',
      icon: 'tabler:chart-line'
    }
  ],
  results: realisationData.realisationsMeta?.impact 
    ? [realisationData.realisationsMeta.impact] 
    : [
        'Amélioration significative de l\'engagement citoyen',
        'Renforcement des capacités locales',
        'Impact positif sur la communauté'
      ],
  testimonial: realisationData.realisationsMeta?.testimonial || null,
  gallery: realisationData.gallery || (realisationData.featuredImage?.node?.mediaItemUrl ? [realisationData.featuredImage.node.mediaItemUrl] : []),
  content: realisationData.content
};

const metadata = {
  title: `${projet.title} | Réalisations | CitizenLab Bénin`,
  description: projet.description,
};
---

<Layout metadata={metadata}>
  <section class="h-[30vh] bg-slate-50 dark:bg-slate-900 flex items-center justify-center">
    <div class="text-center">
       <div class="inline-block px-4 py-1 rounded-full border border-primary/20 bg-primary/5 text-primary text-xs font-bold tracking-[0.3em] uppercase mb-4">
          Étude de Cas
       </div>
       <h1 class="text-slate-400 dark:text-slate-600 font-mono text-sm tracking-widest uppercase">
         CitizenLab Bénin — Archives
       </h1>
    </div>
  </section>
  <main class="relative bg-white dark:bg-slate-950">
    <div class="container mx-auto px-6">
      
      <div class="relative -mt-32 mb-24 max-w-6xl mx-auto">
        <div class="absolute inset-0 bg-primary/10 rounded-[2.5rem] rotate-1 scale-[1.02] -z-10"></div>
        <img
          src={projet.heroImage}
          alt={projet.title}
          class="w-full h-[400px] md:h-[750px] object-cover rounded-[2.5rem] shadow-[0_50px_100px_-20px_rgba(0,0,0,0.3)] border-4 border-white dark:border-slate-900"
        />
      </div>

      <div class="max-w-4xl mx-auto pb-32">
      <div class="flex flex-col md:flex-row gap-12 items-start">
  
  <div class="md:w-1/5 pt-4 flex flex-col items-center">
    <span class="h-1.5 w-16 bg-green-600 hidden md:block mb-12 rounded-full"></span>
    
    <time class="text-2xl font-bold font-mono py-2 text-slate-400 dark:text-slate-600 rotate-0 md:rotate-90 origin-center whitespace-nowrap tracking-wider">
      {new Date(projet.date).getDate() + '-' + (new Date(projet.date).getMonth() + 1) + '-' + new Date(projet.date).getFullYear()}
    </time>
  </div>

  <div class="md:w-4/5">
    <h2 class="text-5xl md:text-7xl font-black text-slate-900 dark:text-white mb-10 leading-[0.9] tracking-tighter">
      {projet.title}
    </h2>
    
    <p class="prose prose-lg prose-green max-w-none
        prose-headings:text-green-900 prose-headings:font-bold
        prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-6
        prose-p:text-gray-700 prose-p:leading-relaxed prose-p:mb-6
        prose-ul:my-6 prose-ul:space-y-3
        prose-li:text-gray-700
        prose-strong:text-green-900 prose-strong:font-semibold">
      {projet.description}
    </p>
  </div>
</div>
      </div>
    </div>
  </main>

  <section class="py-20 bg-slate-50 dark:bg-slate-900/30 border-t border-slate-100 dark:border-slate-800">
    <div class="container mx-auto px-6 text-center">
      <!-- <p class="text-slate-400 mb-8 font-medium">Fin du projet</p> -->
      <a href="/realisations" class="inline-flex items-center gap-4 text-xl font-bold dark:text-white hover:text-primary transition-all group">
        <span class="w-12 h-12 rounded-full border border-slate-200 dark:border-slate-700 flex items-center justify-center group-hover:border-primary group-hover:bg-primary group-hover:text-white transition-all">
         <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
</svg>
        </span>
        Explorer d'autres réalisations
      </a>
    </div>
  </section>
</Layout>

<style>
  /* On rend le titre un peu plus "Design" en jouant sur l'épaisseur */
  h2 {
    word-spacing: -0.1em;
  }

  /* Pour l'image principale au scroll */
  img {
    view-transition-name: project-image;
  }
</style>