---
import Layout from "~/layouts/PageLayout.astro";
import { getAllMagazines } from "~/utils/api.js";

// Génération des chemins statiques
export async function getStaticPaths() {
  const magazines = await getAllMagazines();

  return magazines.map((post: any) => ({
    params: { slug: post.slug },
  }));
}

// Récupération du slug depuis la route
const { slug } = Astro.params;

// Récupération des magazines depuis WP
const magazines = await getAllMagazines();
const magazinePost = magazines.find((post: any) => post.slug === slug);

if (!magazinePost) {
  return Astro.redirect('/magazines');
}

// Transformation des données
const magazine = {
  title: magazinePost.magazine?.titre ?? "Magazine",
  description: magazinePost.magazine?.description ?? "",
  date: magazinePost.magazine?.date
    ? new Date(magazinePost.magazine.date).toLocaleDateString("fr-FR", {
        year: "numeric",
        month: "long",
        day: "numeric",
      })
    : "",
  year: magazinePost.magazine?.date
    ? new Date(magazinePost.magazine.date).getFullYear()
    : "",
  month: magazinePost.magazine?.date
    ? new Date(magazinePost.magazine.date).toLocaleDateString("fr-FR", { month: "short" }).toUpperCase()
    : "",
  image: magazinePost.featuredImage?.node?.mediaItemUrl ?? null,
  imageAlt: magazinePost.featuredImage?.node?.altText ?? magazinePost.magazine?.titre ?? "Magazine",
  pdfUrl: magazinePost.magazine?.fichier?.node?.mediaItemUrl ?? null,
  edition: magazines.findIndex((m: any) => m.slug === slug) + 1,
};

// Autres magazines
const otherMagazines = magazines.filter((m: any) => m.slug !== slug).slice(0, 4);

const metadata = {
  title: `${magazine.title} - Nos Magazines`,
  description: magazine.description,
};
---

<Layout metadata={metadata}>

  <!-- Hero Section - Style Editorial Magazine -->
  <section class="relative min-h-screen bg-[#0a0a0a] overflow-hidden">
    
    <!-- Background Pattern -->
    <div class="absolute inset-0 opacity-[0.03]">
      <div class="absolute inset-0" style="background-image: url('data:image/svg+xml,%3Csvg width=&quot;60&quot; height=&quot;60&quot; viewBox=&quot;0 0 60 60&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cg fill=&quot;none&quot; fill-rule=&quot;evenodd&quot;%3E%3Cg fill=&quot;%23ffffff&quot; fill-opacity=&quot;1&quot;%3E%3Cpath d=&quot;M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z&quot;/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
    </div>

    <!-- Gradient Orbs -->
    <div class="absolute top-0 right-0 w-[800px] h-[800px] bg-emerald-500/10 rounded-full blur-[150px] -translate-y-1/2 translate-x-1/2"></div>
    <div class="absolute bottom-0 left-0 w-[600px] h-[600px] bg-teal-500/10 rounded-full blur-[120px] translate-y-1/2 -translate-x-1/2"></div>

    <div class="relative z-10 max-w-screen-2xl mx-auto px-6 md:px-12 lg:px-20">
      
      <!-- Top Navigation -->
      <nav class="flex items-center justify-between py-8 border-b border-white/10">
        <a href="/magazines" class="group flex items-center gap-3 text-white/60 hover:text-white transition-colors">
          <div class="w-10 h-10 rounded-full border border-white/20 flex items-center justify-center group-hover:border-white/40 group-hover:bg-white/5 transition-all">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
          </div>
          <span class="text-sm font-medium tracking-wide">Tous les magazines</span>
        </a>
      </nav>

      <!-- Main Hero Content -->
      <div class="grid lg:grid-cols-2 gap-12 lg:gap-20 py-16 lg:py-24 items-center">
        
        <!-- Left: Magazine Cover with 3D Effect -->
        <div class="relative order-2 lg:order-1">
          <div class="relative mx-auto max-w-md lg:max-w-none perspective-1000">
            
            <!-- Floating elements -->
            <div class="absolute -top-8 -left-8 w-24 h-24 border border-emerald-500/30 rounded-2xl rotate-12 animate-pulse"></div>
            <div class="absolute -bottom-6 -right-6 w-16 h-16 bg-gradient-to-br from-emerald-500/20 to-teal-500/20 rounded-xl -rotate-12"></div>
            
            <!-- Magazine Cover -->
            <div class="relative group">
              <!-- Shadow -->
              <div class="absolute inset-0 bg-gradient-to-br from-emerald-600/40 to-teal-600/40 rounded-2xl blur-2xl transform translate-y-8 scale-95 opacity-60 group-hover:opacity-80 transition-opacity duration-500"></div>
              
              <!-- Cover Image -->
              <div class="relative bg-gradient-to-br from-white/10 to-white/5 p-3 rounded-2xl backdrop-blur-sm border border-white/10 transform transition-transform duration-500 group-hover:scale-[1.02] group-hover:-rotate-1">
                {magazine.image ? (
                  <img 
                    src={magazine.image} 
                    alt={magazine.imageAlt}
                    class="w-full aspect-[3/4] object-cover rounded-xl"
                  />
                ) : (
                  <div class="w-full aspect-[3/4] bg-gradient-to-br from-emerald-900 to-teal-900 rounded-xl flex items-center justify-center">
                    <div class="text-center">
                      <div class="w-20 h-[1px] bg-white/20 mx-auto mb-4"></div>
                      <span class="text-white/40 text-2xl font-light tracking-widest">MAGAZINE</span>
                      <div class="w-20 h-[1px] bg-white/20 mx-auto mt-4"></div>
                    </div>
                  </div>
                )}
                
                <!-- Edition Badge -->
                <div class="absolute -top-4 -right-4 w-20 h-20 bg-gradient-to-br from-emerald-500 to-teal-500 rounded-2xl flex flex-col items-center justify-center shadow-2xl shadow-emerald-500/30 transform rotate-6 group-hover:rotate-12 transition-transform">
                  <span class="text-[10px] text-white/80 font-medium tracking-widest">ÉDITION</span>
                  <span class="text-2xl text-white font-black">N°{String(magazine.edition).padStart(2, '0')}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Magazine Info -->
        <div class="order-1 lg:order-2 text-white">
          
          <!-- Date -->
          <div class="flex items-center gap-4 mb-8">
            <div class="flex items-center gap-2 px-4 py-2 bg-white/5 rounded-full border border-white/10">
              <svg class="w-4 h-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <span class="text-sm text-white/70">{magazine.date}</span>
            </div>
          </div>

          <!-- Title -->
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-black leading-[1.1] mb-6">
            <span class="bg-gradient-to-r from-white via-white to-white/60 bg-clip-text text-transparent">
              {magazine.title}
            </span>
          </h1>

          <!-- Description -->
          <p class="text-lg md:text-xl text-white/60 leading-relaxed mb-10 max-w-xl">
            {magazine.description}
          </p>

          <!-- CTA Buttons -->
          <div class="flex flex-col sm:flex-row gap-4">
            {magazine.pdfUrl && (
              <a
                href={magazine.pdfUrl}
                download
                target="_blank"
                rel="noopener noreferrer"
                class="group relative inline-flex items-center justify-center gap-3 px-8 py-4 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-full font-bold text-white overflow-hidden transition-all duration-300 hover:shadow-lg hover:shadow-emerald-500/30"
              >
                <span class="relative z-10 flex items-center gap-3">
                  <svg class="w-5 h-5 transition-transform group-hover:translate-y-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                  </svg>
                  Télécharger le PDF
                </span>
                <div class="absolute inset-0 bg-gradient-to-r from-emerald-600 to-teal-600 opacity-0 group-hover:opacity-100 transition-opacity"></div>
              </a>
            )}
            
            <a
              href="#lire"
              class="group inline-flex items-center justify-center gap-3 px-8 py-4 bg-white/5 border border-white/20 rounded-full font-bold text-white hover:bg-white/10 hover:border-white/30 transition-all duration-300"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
              </svg>
              Lire en ligne
            </a>
          </div>

          <!-- Stats -->
          <div class="flex items-center gap-8 mt-12 pt-8 border-t border-white/10">
            <div>
              <span class="block text-3xl font-black text-emerald-400">{String(magazine.edition).padStart(2, '0')}</span>
              <span class="text-sm text-white/40">Édition</span>
            </div>
            <div class="w-px h-12 bg-white/10"></div>
            <div>
              <span class="block text-3xl font-black text-white">{magazine.year}</span>
              <span class="text-sm text-white/40">Année</span>
            </div>
            <div class="w-px h-12 bg-white/10"></div>
            <div>
              <span class="block text-3xl font-black text-teal-400">PDF</span>
              <span class="text-sm text-white/40">Format</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Scroll Indicator -->
      <div class="absolute bottom-8 left-1/2 -translate-x-1/2 flex flex-col items-center gap-2 text-white/40">
        <span class="text-xs tracking-widest uppercase">Défiler</span>
        <div class="w-6 h-10 border-2 border-white/20 rounded-full flex justify-center pt-2">
          <div class="w-1.5 h-3 bg-white/40 rounded-full animate-bounce"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- PDF Reader Section -->
  {magazine.pdfUrl && (
    <section id="lire" class="py-20 md:py-32 bg-[#f8f8f6]">
      <div class="max-w-screen-xl mx-auto px-6 md:px-12">
        
        <!-- Section Header -->
        <div class="text-center mb-16">
          <span class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-100 text-emerald-700 rounded-full text-sm font-semibold mb-6">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
            </svg>
            Lecture en ligne
          </span>
          <h2 class="text-3xl md:text-5xl font-black text-center text-gray-900 mb-4">
            Feuilleter le magazine
          </h2>
          <p class="text-center text-lg text-gray-500">
            Parcourez les pages de cette édition directement depuis votre navigateur
          </p>
        </div>

        <!-- PDF Viewer -->
        <div class="relative">
          <!-- Decorative Elements -->
          <div class="absolute -top-6 -left-6 w-12 h-12 border-2 border-emerald-200 rounded-xl rotate-12"></div>
          <div class="absolute -bottom-6 -right-6 w-8 h-8 bg-teal-100 rounded-lg -rotate-12"></div>
          
          <div class="relative bg-white rounded-3xl shadow-2xl overflow-hidden border border-gray-100">
            <!-- Toolbar -->
            <div class="flex items-center justify-between px-6 py-4 bg-gray-50 border-b border-gray-100">
              <div class="flex items-center gap-4">
                <div class="flex items-center gap-1.5">
                  <span class="w-3 h-3 rounded-full bg-red-400"></span>
                  <span class="w-3 h-3 rounded-full bg-amber-400"></span>
                  <span class="w-3 h-3 rounded-full bg-emerald-400"></span>
                </div>
                <span class="text-sm text-gray-500 font-medium">{magazine.title}.pdf</span>
              </div>
              <a
                href={magazine.pdfUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="flex items-center gap-2 text-sm font-semibold text-emerald-600 hover:text-emerald-700 transition-colors"
              >
                <span>Ouvrir en plein écran</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                </svg>
              </a>
            </div>
            
            <!-- PDF Frame -->
            <iframe
              src={`${magazine.pdfUrl}#toolbar=0&navpanes=0`}
              class="w-full h-[600px] md:h-[800px]"
              title={`Lecture de ${magazine.title}`}
              
            ></iframe>
          </div>
        </div>
      </div>
    </section>
  )}

  <!-- Other Magazines Section -->
  {otherMagazines.length > 0 && (
    <section class="py-20 md:py-32 bg-white">
      <div class="max-w-screen-xl mx-auto px-6 md:px-12">
        
        <!-- Section Header -->
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6 mb-16">
          <div>
            <span class="inline-flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-600 rounded-full text-sm font-semibold mb-6">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
              </svg>
              Collection
            </span>
            <h2 class="text-3xl md:text-5xl font-black text-gray-900">
              Découvrez aussi
            </h2>
          </div>
          <a 
            href="/magazines" 
            class="inline-flex items-center gap-2 text-emerald-600 hover:text-emerald-700 font-bold transition-colors group"
          >
            <span>Voir toute la collection</span>
            <svg class="w-5 h-5 transition-transform group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25L21 12m0 0l-3.75 3.75M21 12H3" />
            </svg>
          </a>
        </div>

        <!-- Magazines Grid -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 md:gap-8">
          {otherMagazines.map((otherPost: any) => {
            const other = otherPost.magazine;
            const otherImage = otherPost.featuredImage?.node?.mediaItemUrl;
            const otherIndex = magazines.findIndex((m: any) => m.slug === otherPost.slug) + 1;

            return (
              <a href={`/magazines/${otherPost.slug}`} class="group block">
                <article class="relative">
                  <!-- Cover -->
                  <div class="relative mb-5 overflow-hidden rounded-2xl bg-gray-100">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500 z-10"></div>
                    
                    {otherImage ? (
                      <img
                        src={otherImage}
                        alt={other?.titre || "Magazine"}
                        class="w-full aspect-[3/4] object-cover transition-transform duration-700 group-hover:scale-105"
                        loading="lazy"
                      />
                    ) : (
                      <div class="w-full aspect-[3/4] bg-gradient-to-br from-emerald-800 to-teal-700 flex items-center justify-center">
                        <span class="text-white/40 font-light tracking-widest text-sm">MAGAZINE</span>
                      </div>
                    )}
                    
                    <!-- Edition Badge -->
                    <div class="absolute top-3 left-3 bg-white/90 backdrop-blur-sm px-3 py-1.5 rounded-lg text-xs font-black text-gray-900 shadow-lg z-20">
                      N°{String(otherIndex).padStart(2, '0')}
                    </div>
                    
                    <!-- Hover CTA -->
                    <div class="absolute bottom-4 left-4 right-4 opacity-0 group-hover:opacity-100 transition-all duration-300 translate-y-2 group-hover:translate-y-0 z-20">
                      <span class="inline-flex items-center gap-2 bg-white text-gray-900 px-4 py-2 rounded-full text-sm font-bold w-full justify-center">
                        Découvrir
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                        </svg>
                      </span>
                    </div>
                  </div>
                  
                  <!-- Info -->
                  <div>
                    {other?.date && (
                      <time class="text-emerald-600 text-xs font-bold uppercase tracking-wider mb-2 block">
                        {new Date(other.date).toLocaleDateString("fr-FR", { month: "long", year: "numeric" })}
                      </time>
                    )}
                    <h3 class="font-bold text-gray-900 group-hover:text-emerald-600 transition-colors line-clamp-2 leading-snug">
                      {other?.titre}
                    </h3>
                  </div>
                </article>
              </a>
            );
          })}
        </div>
      </div>
    </section>
  )}


</Layout>