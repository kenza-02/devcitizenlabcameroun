---
import Layout from "~/layouts/PageLayout.astro";
import Banner from "~/components/widgets/Banner.astro";
import { getAllActualites } from "~/utils/api";
import { Image } from "astro:assets";
import actualiteImg from "~/assets/images/actualite.jpg";

const wpArticles = await getAllActualites();

const metadata = {
  title: "Actualités et medias",
};

const articles = wpArticles.map((post: any) => {
  // Nettoyer l'excerpt des balises HTML
  const cleanDescription =
    post.excerpt
      ?.replace(/<[^>]*>/g, "") // Supprime toutes les balises HTML
      ?.replace(/&nbsp;/g, " ") // Remplace les espaces insécables
      ?.replace(/&#8230;/g, "...") // Remplace les entités HTML
      ?.trim() // Supprime les espaces au début et à la fin
      ?.slice(0, 150) + "..." || ""; // Limite à 150 caractères

  return {
    slug: post.slug,
    data: {
      title: post.title,
      description: cleanDescription,
      date: new Date(post.date).toLocaleDateString("fr-FR", {
        year: "numeric",
        month: "long",
        day: "numeric",
      }),
      category: post.categories?.nodes?.[0]?.name ?? "Actualité",
      image: post.featuredImage?.node?.mediaItemUrl,
    },
  };
});
---

<Layout metadata={metadata}>
  <Banner
    title={metadata.title}
    subtitle="Nous sommes là pour vous aider. N'hésitez pas à nous envoyer un message !"
  >
    <Image
      src={actualiteImg}
      alt="actualités et médias"
      class="w-full h-full object-cover absolute inset-0 border-0 z-0 scale-110 transition-transform duration-700"
    />
  </Banner>

  <section class="py-20 px-10" id="news-section">
    <div class="flex justify-between items-center flex-wrap gap-4">
      <h2 class="text-xl font-semibold text-green-800">
        Nos dernières actualités
      </h2>
      
    </div>

    <!-- Grille de cards -->
    <div class="py-12">
      <div
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
        id="cards-grid"
      >
        {
          articles.map((article: any) => (
            <a href={`/news/${article.slug}`} class="block h-full">
              <article
                class="news-card bg-white rounded-3xl overflow-hidden shadow-md hover:shadow-2xl transition-all duration-500 group cursor-pointer
                h-[520px] flex flex-col"
                data-category={article.data.category}
              >
                {/* Image */}
                <div class="relative h-72 overflow-hidden px-4 shrink-0">
                  <img
                    src={article.data.image}
                    alt={article.data.title}
                    class="w-full rounded-xl h-full object-cover group-hover:scale-110 transition-transform duration-700"
                  />
                </div>

                {/* Contenu */}
                <div class="p-8 flex flex-col flex-1">
                  <span class="inline-block text-xs font-semibold text-gray-700 uppercase tracking-wider mb-3">
                    {article.data.category} • {article.data.date}
                  </span>

                  <h3 class="text-lg font-bold text-green-800 mb-3">
                    {article.data.title}
                  </h3>

                  <p class="text-gray-600 text-sm line-clamp-3">
                    {article.data.description}
                  </p>

                  <div class="flex justify-end mt-auto">
                    <span class="inline-flex items-center justify-center w-12 h-12 bg-green-50 group-hover:bg-green-700 rounded-full transition-all duration-300">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        class="w-5 h-5 text-green-600 group-hover:text-white transition-colors"
                      >
                        <path d="M7 17L17 7" />
                        <path d="M7 7h10v10" />
                      </svg>
                    </span>
                  </div>
                </div>
              </article>
            </a>
          ))
        }
      </div>
    </div>
  </section>

  <!-- Script pour le filtrage -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const buttons = document.querySelectorAll(".category-btn");
      const cards = document.querySelectorAll(".news-card");

      buttons.forEach((btn: any) => {
        btn.addEventListener("click", () => {
          const selected = btn.dataset.category;

          // Styles actifs
          buttons.forEach((b) =>
            b.classList.remove("bg-green-600", "text-white")
          );
          buttons.forEach((b) =>
            b.classList.add("bg-green-50", "text-green-900")
          );
          btn.classList.add("bg-green-600", "text-white");
          btn.classList.remove("bg-green-50", "text-green-900");

          // Filtrage
          cards.forEach((card: any) => {
            if (selected === "Toutes" || card.dataset.category === selected) {
              card.style.display = "block";
              card.style.opacity = 1;
              card.style.transform = "scale(1)";
            } else {
              card.style.opacity = 0;
              card.style.transform = "scale(0.95)";
              setTimeout(() => (card.style.display = "none"), 200);
            }
          });
        });
      });
    });
  </script>
</Layout>
